<!DOCTYPE html>
<html>
  <head>
  <title>Rocky Jaiswal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="utf-8" />
  <meta http-equiv='X-UA-Compatible' content='IE=edge;chrome=1' />
  <link href="/stylesheets/app.css" media="screen" rel="stylesheet" type="text/css" />
  <link href="/stylesheets/bootstrap.css" media="screen" rel="stylesheet" type="text/css" />
  <link href="/stylesheets/bootstrap-responsive.css" media="screen" rel="stylesheet" type="text/css" />
  <script src="/javascripts/bootstrap.js" type="text/javascript"></script>
</head>
  <body>
    <div class="banner">
  <div class="container">
    <h1>
      <a class="head" href="/"><img src="/images/rockyj_banner.png"/></a>
    </h1>
  </div>
</div>
    <div id="main" role="main" class="container">
      <div class="row">
        <div class="span9">
          <div id="main" role="main">
            <article>
              <h2>
                  <span class="color-orange">Running Rails on Ruby or JRuby - A Performance Comparison</span> 
                  <span>Sep  9 2012</span>
              </h2>
              <div class="post">
                <p>I have been a JRuby fanboy for a while now, in the last few weeks I also saw some really interesting RailsCasts on multi-threading Rails applications and JRuby which piqued me to do some ad-hoc experimentation. I recommend everyone to watch these three episodes -</p>

<ul>
<li>
<p><a href='http://railscasts.com/episodes/365-thread-safety'>http://railscasts.com/episodes/365-thread-safety</a></p>
</li>

<li>
<p><a href='http://railscasts.com/episodes/376-jruby-basics'>http://railscasts.com/episodes/376-jruby-basics</a></p>
</li>

<li>
<p><a href='http://railscasts.com/episodes/377-trinidad'>http://railscasts.com/episodes/377-trinidad</a></p>
</li>
</ul>

<p>Now, I am a sucker for performance. I love making performance improvements on applications. So I thought let me run some tests on a simple Rails application on my personal laptop (i7, 8 GB RAM, SSD) and see how well the Ruby implementations and their commonly used servers fare. I will use MRI 1.9.3, JRuby 1.7.0.preview2 and the latest app servers for this experiment.</p>

<p>These tests need to be taken with a pinch of salt as I am no authority in perfomance testing but still the results are quite interesting.</p>

<p>First, we need to setup a Rails app which can be used with both Ruby and JRuby. My Gemfile looks like -</p>

<pre><code>source &#39;https://rubygems.org&#39;

gem &#39;rails&#39;, &#39;3.2.8&#39;
gem &#39;warbler&#39;

platform :jruby do
  gem &#39;activerecord-jdbcpostgresql-adapter&#39;
  gem &#39;jruby-openssl&#39;
  gem &#39;puma&#39;
  gem &#39;trinidad&#39;
  gem &#39;therubyrhino&#39;, group: :assets
end

platform :ruby do
  gem &#39;pg&#39;
  gem &#39;unicorn&#39;
end

# Gems used only for assets and not required
# in production environments by default.
group :assets do
  gem &#39;sass-rails&#39;,   &#39;~&gt; 3.2.3&#39;
  gem &#39;coffee-rails&#39;, &#39;~&gt; 3.2.1&#39;
  gem &#39;uglifier&#39;, &#39;&gt;= 1.0.3&#39;
end

gem &#39;jquery-rails&#39;</code></pre>

<p>Nothing out of the ordinary here, only thing is that the gems will be loaded according to the Ruby implementation.</p>

<p>I also scaffolded a generic User model and added a few records to my database. Pointed the &#8216;root&#8217; of my application to the /users/index page so that the DB is hit everytime someone opens the homepage of the application. I will also use &#8220;ab&#8221; (apache benchmark) as my testing tool, I also tried this with JMeter and there was not much difference. My command is -</p>

<pre><code>ab -n 100 -c 10 http://localhost:8080/</code></pre>

<p>This means my app&#8217;s homepage will be hit by 100 requests with 10 concurrent requests at a time, decent enough for performance testing a small app.</p>

<p>Now lets start the experiment. We will run the experiment on the server in 2 modes, one by not allowing concurrency and the other by allowing concurrency. See tenderlove&#8217;s awesome post to understand this more - <a href='http://tenderlovemaking.com/2012/06/18/removing-config-threadsafe.html'>http://tenderlovemaking.com/2012/06/18/removing-config-threadsafe.html</a>. This is done by commenting / uncommenting this line in production.rb -</p>

<pre><code>config.threadsafe!</code></pre>

<p>We will also run the &#8220;ab&#8221; command above a few times so that cache etc is warmed. The results you see below are always for the 5th or 6th run.</p>

<p>Also, we will precompile our assets and serve them from the app server only. We will run the tests in production mode. I have also increased the DB pool size to 15 so that no bottleneck is created there.</p>

<p>Finally, we kick off our experiment with MRI 1.9.3, Unicorn, 3 workers enabled and concurrency off. Let&#8217;s see the results -</p>

<pre><code>RAILS_ENV=production bundle exec unicorn -c config/unicorn.rb

Requests per second:    549.31 [#/sec] (mean)
Time per request:       18.205 [ms] (mean)</code></pre>

<p>Now lets us allow concurrency (uncomment the &#8220;config.threadsafe!&#8221; line) and re-run the tests -</p>

<pre><code>Requests per second:    525.78 [#/sec] (mean)
Time per request:       19.019 [ms] (mean)</code></pre>

<p>Not much of a difference. This is because MRI uses a GIL and there is no thread level concurrency in MRI. Also reducing the no of workers reduces the performance drastically, if I use 1 worker -</p>

<pre><code>Requests per second:    109.46 [#/sec] (mean)
Time per request:       91.360 [ms] (mean)</code></pre>

<p>Let&#8217;s switch over to JRuby now and use <a href='http://puma.io'>puma</a> as the server, with these JVM options -</p>

<pre><code>export JRUBY_OPTS=&quot;-J-XX:ReservedCodeCacheSize=100m -J-Xmn512m -J-Xms2048m -J-Xmx2048m -J-server&quot;</code></pre>

<p>Server can be started by -</p>

<pre><code>RAILS_ENV=production jruby -S bundle exec puma -p 8080</code></pre>

<p>Results with concurrency off -</p>

<pre><code>Requests per second:    72.37 [#/sec] (mean)
Time per request:       138.184 [ms] (mean)</code></pre>

<p>As you can see this is much much slower than Unicorn.</p>

<p>Lets enable concurrency and retest -</p>

<pre><code>Requests per second:    451.77 [#/sec] (mean)
Time per request:       22.135 [ms] (mean)</code></pre>

<p>Now we see a huge performance boost, we are getting similar results as Unicorn even though we are running just one server process as opposed to Unicorn&#8217;s three. One can imagine the performance for a clustered puma setup.</p>

<p>Lets try the same tests with <a href='http://thinkincode.net/trinidad/'>Trinidad</a> -</p>

<pre><code>RAILS_ENV=production jruby -S bundle exec trinidad -p 8080</code></pre>

<p>Results with concurrency off -</p>

<pre><code>Requests per second:    287.45 [#/sec] (mean)
Time per request:       34.788 [ms] (mean)</code></pre>

<p>This is a bit slow, lets enable concurrency and retest -</p>

<pre><code>Requests per second:    391.74 [#/sec] (mean)
Time per request:       25.527 [ms] (mean)</code></pre>

<p>We see an improvment now. Although, Puma is a tad faster (ignorable).</p>

<p>Lastly with concurrency enabled, we will use the warbler gem to generate a war file and deploy it on standard tomcat.</p>

<p>The results here are startling -</p>

<pre><code>Requests per second:    4268.76 [#/sec] (mean)
Time per request:       2.343 [ms] (mean)</code></pre>

<p>I think we are talking Java level performance here. I don&#8217;t know why there is such a huge difference between Trinidad (which is Tomcat based) and standard Tomcat but it may be due to Trinidad being rack compliant and Tomcat having no such restrictions.</p>

<p>Anyways, here is a summary -</p>

<ul>
<li>Unicorn is fast and performance improves as the number of workers are increased (no surprise!!).</li>

<li>There is no effect of enabling concurrency on Unicorn as MRI uses GIL (Global Interpreter Lock).</li>

<li>When using Unicorn you don&#8217;t have to worry about multithreading.</li>

<li>Puma is fast but only when concurrency is enabled.</li>

<li>Trinidad is almost as fast as Puma.</li>

<li>On JRuby servers the response time improves steadily as the server is hit due to JVM optimizations kicking in.</li>

<li>With concurrency enabled on Puma / Trinidad watch out for thread safety.</li>

<li>If you are looking for pure speed use warbler and Tomcat but you have moved out of the rack compliant world then.</li>
</ul>

<p>Also, with JVM / JRuby / multi-threading, there is big advantage of running jobs in background threads without relying on external processes.</p>

<p>However, with multi-threading enabled, thread safety may be hard to get right. If you have a simple application and you design the application with concurrency in mind (immutable classes, thread safe libraries) then go ahead and use JRuby with Puma / Trinidad / Torquebox. Learn more from a great post here -</p>

<p><a href='https://github.com/jruby/jruby/wiki/Concurrency-in-jruby'>https://github.com/jruby/jruby/wiki/Concurrency-in-jruby</a></p>
              </div>
              <hr/>
              <div id="disqus_thread"></div>
                <script type="text/javascript">
                    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
                    var disqus_shortname = 'rockyj'; // required: replace example with your forum shortname

                    /* * * DON'T EDIT BELOW THIS LINE * * */
                    (function() {
                        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                    })();
                </script>
                <noscript>
                  Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
                </noscript>
                <a href="http://disqus.com" class="dsq-brlink">
                  blog comments powered by <span class="logo-disqus">Disqus</span>
                </a>
            </article>
          </div>
        </div>
        <div class="span3">
  <h2>
    <img src="/images/Rocky_Jaiswal.jpg" alt="Rocky Jaiswal" width="121" height="115" style="max-width: 100%;"/>
    <br/>
    <a href="/about">About</a>
  </h2>
  <hr/>
  <h2>
    <a href="http://github.com/rocky-jaiswal" target="_blank">Github</a>
  </h2>
  <hr/>
  <h2>Articles</h2>
  <ol>
    
      <li><a href="/2012/09/09/rails_on_ruby_jruby_a_performance_comparison.html">Running Rails on Ruby or JRuby - A Performance Comparison</a> <span>Sep  9 2012</span></li>
    
      <li><a href="/2012/09/01/deploying_java_apps_with_capistrano.html">Deploying Java applications with Capistrano</a> <span>Sep  1 2012</span></li>
    
      <li><a href="/2012/08/26/accessing_server_data_from_a_native_android_app.html">Accessing server data from a native Android app</a> <span>Aug 26 2012</span></li>
    
      <li><a href="/2012/08/18/why_javascript_is_important.html">Why JavaScript is important</a> <span>Aug 18 2012</span></li>
    
      <li><a href="/2012/06/08/non_tangibles_of_agile.html">The non-tangibles of Agile</a> <span>Jun  8 2012</span></li>
    
      <li><a href="/2012/05/28/moved_to_html.html">Blog moved to pure HTML5, CSS3</a> <span>May 28 2012</span></li>
    
      <li><a href="/2012/05/25/intro_to_backbone_jQuery.html">A gentle introduction to Backbone with jQuery</a> <span>May 25 2012</span></li>
    
      <li><a href="/2012/05/21/video_rubyconf_india.html">Video of my talk with @arunagw at RubyConf India 2012</a> <span>May 21 2012</span></li>
    
      <li><a href="/2012/05/08/setting_up_solr.html">Setting up Solr</a> <span>May  8 2012</span></li>
    
      <li><a href="/2012/03/27/old_jboss_video.html">Old JBoss Video</a> <span>Mar 27 2012</span></li>
    
      <li><a href="/2012/03/26/ruby_conf_india_with_arunagw.html">Slides of my talk with @arunagw in Ruby Conf India 2012</a> <span>Mar 26 2012</span></li>
    
      <li><a href="/2012/03/23/embracing_jruby_1.html">Embracing JRuby - Part 1</a> <span>Mar 23 2012</span></li>
    
      <li><a href="/2012/03/05/musings_on_india_and_technology.html">Musings on India and Technology</a> <span>Mar  5 2012</span></li>
    
      <li><a href="/2012/01/31/job_of_a_software_developer.html">The Job of a Software Developer</a> <span>Jan 31 2012</span></li>
    
      <li><a href="/2011/12/27/a-weekend-with-couchdb-solr-and-torquebox.html">A weekend with CouchDB, Solr and Torquebox</a> <span>Dec 27 2011</span></li>
    
      <li><a href="/2011/12/27/configuring-nginx-with-jboss-tomcat.html">Configuring nginx with JBoss / Tomcat</a> <span>Dec 27 2011</span></li>
    
      <li><a href="/2011/12/01/jquery-flavored-coffeescript.html">jQuery flavored CoffeeScript</a> <span>Dec  1 2011</span></li>
    
      <li><a href="/2011/07/26/and-then-there-was-closure.html">And then there was Closure</a> <span>Jul 26 2011</span></li>
    
      <li><a href="/2011/07/04/the-problem-is-choice.html">The problem is choice</a> <span>Jul  4 2011</span></li>
    
      <li><a href="/2011/06/29/using-spring-for-scheduling-tasks.html">Using Spring for Scheduling Tasks</a> <span>Jun 29 2011</span></li>
    
      <li><a href="/2011/06/25/working-with-oracle-on-linux-ubuntu-fedora.html">Installing Oracle on Linux (Ubuntu / Fedora)</a> <span>Jun 25 2011</span></li>
    
      <li><a href="/2011/06/25/excel-manipulation-and-testing-in-java.html">Excel manipulation and testing in Java</a> <span>Jun 25 2011</span></li>
    
      <li><a href="/2011/06/06/putting-couchdb-and-rails-on-the-cloud.html">Putting CouchDB and Rails on the Cloud</a> <span>Jun  6 2011</span></li>
    
      <li><a href="/2011/05/16/integrating-google-re-captcha-with-a-rails-app.html">Integrating Google Re-Captcha with a Rails app</a> <span>May 16 2011</span></li>
    
      <li><a href="/2011/05/03/the-real-purpose-of-a-sprint-goal.html">The real purpose of a Sprint Goal</a> <span>May  3 2011</span></li>
    
      <li><a href="/2011/05/02/views-from-across-the-table.html">Views from across the table</a> <span>May  2 2011</span></li>
    
      <li><a href="/2011/05/02/thoughts-of-the-week-24-30-april.html">Thoughts of the week 24 - 30 April</a> <span>May  2 2011</span></li>
    
      <li><a href="/2011/04/20/be-happy-to-fail.html">Be Happy to Fail</a> <span>Apr 20 2011</span></li>
    
      <li><a href="/2011/04/14/using-rvm-on-ubuntu-to-install-multiple-versions-of-ruby.html">Using RVM on Ubuntu to install (multiple versions of) Ruby</a> <span>Apr 14 2011</span></li>
    
      <li><a href="/2011/04/11/thoughts-of-the-week-4-10-april.html">Thoughts of the week (4 - 10 April)</a> <span>Apr 11 2011</span></li>
    
      <li><a href="/2011/04/08/mapreduce-in-english.html">MapReduce in English</a> <span>Apr  8 2011</span></li>
    
      <li><a href="/2011/04/01/java-and-ruby-integration-via-soap.html">Java and Ruby integration via SOAP</a> <span>Apr  1 2011</span></li>
    
      <li><a href="/2011/04/01/hello-world.html">Integrating JRuby and Java to create a mini rules engine</a> <span>Apr  1 2011</span></li>
    
      <li><a href="/2011/03/31/accessing-jboss-managed-resources-using-mbeans.html">Accessing JBoss managed resources using MBeans</a> <span>Mar 31 2011</span></li>
    
      <li><a href="/2011/03/31/from-zero-to-a-crud-app-without-writing-a-single-line-of-code-using-jruby.html">From Zero to a CRUD App (without writing a single line of code) using JRuby</a> <span>Mar 31 2011</span></li>
    
      <li><a href="/2011/03/31/google-app-engine-maven-jsf2.html">Google App Engine + Maven + JSF2</a> <span>Mar 31 2011</span></li>
    
      <li><a href="/2011/03/31/hello-jquery.html">Hello jQuery!</a> <span>Mar 31 2011</span></li>
    
      <li><a href="/2011/03/31/integrating-spring-3-with-jpa-2.html">Integrating Spring 3 with JPA 2</a> <span>Mar 31 2011</span></li>
    
      <li><a href="/2011/03/11/big-bad-projects.html">Big bad projects</a> <span>Mar 11 2011</span></li>
    
      <li><a href="/2011/03/01/working-with-git.html">Working with Git</a> <span>Mar  1 2011</span></li>
    
  </ol>
  <hr/>
  <h2>Tags</h2>
  <ol>
    
      <li><a href="tags/jboss.html">JBoss (2)</a></li>
    
      <li><a href="tags/agile.html">Agile (7)</a></li>
    
      <li><a href="tags/general.html">General (6)</a></li>
    
      <li><a href="tags/java.html">Java (8)</a></li>
    
      <li><a href="tags/jruby.html">JRuby (8)</a></li>
    
      <li><a href="tags/ruby.html">Ruby (7)</a></li>
    
      <li><a href="tags/capistrano.html">Capistrano (1)</a></li>
    
      <li><a href="tags/git.html">Git (1)</a></li>
    
      <li><a href="tags/javascript.html">JavaScript (4)</a></li>
    
      <li><a href="tags/solr.html">Solr (2)</a></li>
    
      <li><a href="tags/jpa.html">JPA (1)</a></li>
    
      <li><a href="tags/spring.html">Spring (2)</a></li>
    
      <li><a href="tags/coffeescript.html">CoffeeScript (1)</a></li>
    
      <li><a href="tags/rails.html">Rails (3)</a></li>
    
      <li><a href="tags/torquebox.html">Torquebox (3)</a></li>
    
      <li><a href="tags/couchdb.html">CouchDB (2)</a></li>
    
      <li><a href="tags/nosql.html">NoSQL (1)</a></li>
    
      <li><a href="tags/jquery.html">jQuery (1)</a></li>
    
      <li><a href="tags/backbone.html">Backbone (2)</a></li>
    
      <li><a href="tags/linux.html">Linux (1)</a></li>
    
      <li><a href="tags/programming.html">Programming (1)</a></li>
    
      <li><a href="tags/android.html">Android (1)</a></li>
    
      <li><a href="tags/phonegap.html">Phonegap (1)</a></li>
    
      <li><a href="tags/jboss.html">Jboss (1)</a></li>
    
      <li><a href="tags/tomcat.html">Tomcat (1)</a></li>
    
      <li><a href="tags/cloud.html">Cloud (1)</a></li>
    
      <li><a href="tags/maven.html">Maven (1)</a></li>
    
  </ol>
  <hr/>
</div>
      </div>
    </div>
  </body>
</html>