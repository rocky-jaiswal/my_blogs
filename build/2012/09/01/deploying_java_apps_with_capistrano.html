<!DOCTYPE html>
<html>
  <head>
  <title>Rocky Jaiswal Deploying Java applications with Capistrano</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="utf-8" />
  <meta http-equiv='X-UA-Compatible' content='IE=edge;chrome=1' />
  <link href="/stylesheets/bootstrap.min.css" media="screen" rel="stylesheet" type="text/css" />
  <link href="/stylesheets/bootstrap-responsive.min.css" media="screen" rel="stylesheet" type="text/css" />
  <link href="/stylesheets/github.css" media="screen" rel="stylesheet" type="text/css" />
  <link href="/stylesheets/punchable.css" media="screen" rel="stylesheet" type="text/css" />
  <link href="/stylesheets/app.css" media="screen" rel="stylesheet" type="text/css" />
  <script src="/javascripts/jquery.js" type="text/javascript"></script>
  <script src="/javascripts/bootstrap.min.js" type="text/javascript"></script>
  <script src="/javascripts/highlight.pack.js" type="text/javascript"></script>
</head>
  <body>
    <div class="banner navbar-fixed-top">
  <div class="container">
    <h1>
      <a class="head" href="/"><img src="/images/rockyj_banner.png"/></a>
    </h1>
  </div>
</div>
    <div id="main" role="main" class="container">
      <div class="row">
        <div class="span9">
          <div id="main" role="main">
            <article>
              <h2 style="padding-bottom: 10px;">
                  <span class="highlighted">Deploying Java applications with Capistrano</span> 
                  <span>Sep  1 2012</span>
              </h2>
              <div class="post">
                <p>The advantage of learning a few programming languages is that you apply one's paradigms to the other. When I was a Java programmer I never gave much thought to deployment. Maven would build a war file, which would be copied to the application server through a shell script or even via the IDE. For remote deployments we would just do the same from the build server via scp. I always found the Maven "Cargo" plugin too complicated so let just skip that for now.</p>

<p>Then I came into the Ruby world and learned (a bit) about Capistrano and was absolutely fascinated by it. It did so much so easily for deployment that using anything else seems pre-historic.</p>

<p>So I started suggesting my Java friends to use Capistrano. This post is my first attempt at deploying a Java EE6 project with Capistrano.</p>

<p>Lets start by creating a Java EE6 project from Maven (or whichever way you like). To keep our lives simple and stay withing the JVM world we will use JRuby (1.7.0 preview 2). If you already have JRuby setup run a "gem update" to avoid any pain.</p>

<p>Now just install the Capistrano gem in JRuby by running - </p>

<pre><code>gem install capistrano
</code></pre>

<p>Now in the root directory of our JavaEE project run -</p>

<pre><code>capify .
</code></pre>

<p>Capistrano will now create some files with some default entries. </p>

<p>Now, we will also use the Tomcat Manager for deployment so read up a bit <a href="http://tomcat.apache.org/tomcat-7.0-doc/manager-howto.html">here</a> and setup your manager in $TOMCAT_HOME/conf/tomcat-users.xml. Make sure you give the manager <strong>"manager-script"</strong> role so that we can do automated command line deployments through the manager.</p>

<p>We'll start of by using Capistrano for local deployment, I know that can be easily done through an IDE but we'll start off with this and for doing remote deployments it will be just a matter of changing the hostname and paths (and SSH setup of course).</p>

<p>So lets look at the capfile we update in $your-javaee-project/config/deploy.rb</p>

<pre><code>set :application, "jdeployer"
set :scm, "git"
set :repository, "git@github.com:rocky-jaiswal/#{application}.git"
set :branch, "master"

default_run_options[:pty] = true
ssh_options[:forward_agent] = true #Line 7

task :local do
    roles.clear
    server "localhost", :app #Line 11
    set :user, "rockyj" 
    set :java_home, "/home/#{user}/jdk1.7.0_05" #Line 13
    set :tomcat_home, "/home/#{user}/Apps/apache-tomcat-7.0.29"
    set :tomcat_manager, "manager"
    set :tomcat_manager_password, "manager"
    set :maven_home, "/home/#{user}/Apps/apache-maven-3.0.4"
    set :deploy_to, "/home/#{user}/tmp/#{application}" # Line 18
    set :use_sudo, false
    namespace :tomcat do
      task :deploy do
        puts "==================Building with Maven======================" #Line 22
        run "export JAVA_HOME=#{java_home} &amp;&amp; cd #{deploy_to}/current &amp;&amp; #{maven_home}/bin/mvn clean package"
        puts "==================Undeploy war======================"#Line 24
        run "curl --user #{tomcat_manager}:#{tomcat_manager_password} http://$CAPISTRANO:HOST$:8080/manager/text/undeploy?path=/#{application}"
        puts "==================Deploy war to Tomcat======================" #Line 26
        run "curl --upload-file #{deploy_to}/current/target/#{application}*.war --user #{tomcat_manager}:#{tomcat_manager_password} http://$CAPISTRANO:HOST$:8080/manager/text/deploy?path=/#{application}"
      end
    end
    after "deploy", "tomcat:deploy" #Line 30
    after "tomcat:deploy", "deploy:cleanup" # keep only the last 5 releases
end 
</code></pre>

<p>Line 1 - 7 : We are using github as our code repo and the first 7 lines are basic Capistrano setup (nothing much to talk about). </p>

<p>Line 11 - 18 : Then we define a custom task / namespace to keep our experiment isolated. We set the Java, Tomcat and other paths to get the basic setup in place. We will also use Maven to build our app so we specify its path as well. We will build the app in a temporary folder so we set that path as well. </p>

<p>Line 30 : The default Capistrano task is "deploy" which will take the updated version of code from git check it out in the specified directory. After the deploy command we will run our own custom commands through Capistrano's DSL. </p>

<p>Line 22 - 23 : Now we start using Capistrano's DSL and run commands on remote servers via ssh. First we set the right JAVA_HOME and change the directory to where our code is. Then we build our project through Maven. Please note we need to run the commands in the same shell and that is why we do "command a &amp;&amp; command b". We cannot specify commands in separate lines as Capistrano opens a new shell for each command when we run it with the "run" method call.</p>

<p>Line 24 - 27 : Next using the Tomcat manager and curl (since Tomcat Manager works on HTTP), we undeploy the existing version of the application and finally deploy the Maven built new version. We use the "$CAPISTRANO:HOST" variable to avoid hardcoding and getting the hostname where Capistrano commands are being run.</p>

<p>We will first test this on localhost, so make sure you have your local ssh server running. In Fedora I do -</p>

<pre><code>sudo service sshd start
</code></pre>

<p>Finally, make sure you have local SSH keys setup and your Tomcat is running with the manager properly configured. Now finally run this single command to deploy your Java application -</p>

<pre><code>cap local deploy
</code></pre>

<p>That is it, since the build is made from github make sure you push your changes out before running this command to see your changes on the browser. This may seem a lot for a local deploy but now just change the ":server" hostname to deploy to a server remotely (ofcourse, you may need to change your Maven / JDK paths as well according to your remote server setup). After this you can now deploy a new "war" build to a remote server with a single command. You can also write your own custom tasks with Capistrano and sit back and enjoy painless deployments.</p>


              </div>
              <hr/>
              <div id="disqus_thread"></div>
                <script type="text/javascript">
                  $(function(){
                    hljs.initHighlightingOnLoad();
                    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
                    var disqus_shortname = 'rockyj'; // required: replace example with your forum shortname

                    /* * * DON'T EDIT BELOW THIS LINE * * */
                    (function() {
                        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                    })();
                  });
                </script>
                <noscript>
                  Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
                </noscript>
                <a href="http://disqus.com" class="dsq-brlink">
                  blog comments powered by <span class="logo-disqus">Disqus</span>
                </a>
            </article>
          </div>
        </div>
        <div class="span3">
          <div id="sidebar">
  <h3>
    <!--<img src="/images/Rocky_Jaiswal.jpg" alt="Rocky Jaiswal" width="121" height="115" style="max-width: 100%;"/>-->
    <br/>
    <a href="/about">About</a>
  </h3>
  <hr/>
  <h3>
    <a href="https://github.com/rocky-jaiswal" target="_blank">Github</a> /
    <a href="https://twitter.com/whatsuprocky" target="_blank">Twitter</a>
  </h3>
  <hr/>
  <h3>
    <a href="/videos">Videos</a>
  </h3>
  <hr/>
  <h3><a id="show-posts" href="#/posts">Posts</a> / <a id="show-tags" href="#/tags">Tags</a></h3>
  <div class="posts">
    <ol>
      
        <li><a href="/2013/05/24/angular_hacks.html">Angular.js Hacks</a> <span>May 24 2013</span></li>
      
        <li><a href="/2013/05/11/yeoman_and_backbone.html">Building HTML5 Apps with Yeoman and Backbone</a> <span>May 11 2013</span></li>
      
        <li><a href="/2013/05/03/what_motivates_programmers.html">What motivates programmers</a> <span>May  3 2013</span></li>
      
        <li><a href="/2013/05/02/ajaxify_with_backbone.html">Ajaxify a Form with Backbone</a> <span>May  2 2013</span></li>
      
        <li><a href="/2013/04/08/puppet_in_a_rush.html">Puppet in a rush</a> <span>Apr  8 2013</span></li>
      
        <li><a href="/2013/04/01/building_single_page_applications_and_cors.html">Building Single Page Applications and CORS</a> <span>Apr  1 2013</span></li>
      
        <li><a href="/2013/03/22/integrating_node_and_rails_with_redis.html">Integrating Rails and Node.js via Redis</a> <span>Mar 22 2013</span></li>
      
        <li><a href="/2012/12/13/backbone_and_coffeescript.html">Backbone.js and CoffeeScript - A Perfect Match</a> <span>Dec 13 2012</span></li>
      
        <li><a href="/2012/12/02/serving_rails_from_windows.html">Serving Rails from Windows</a> <span>Dec  2 2012</span></li>
      
        <li><a href="/2012/10/15/why_does_js_require_requirejs.html">Why does JavaScript require Require.js</a> <span>Oct 15 2012</span></li>
      
        <li><a href="/2012/09/22/rails_on_only_jvm.html">Rails on only JVM</a> <span>Sep 22 2012</span></li>
      
        <li><a href="/2012/09/15/akka_with_jruby.html">Akka with JRuby</a> <span>Sep 15 2012</span></li>
      
        <li><a href="/2012/09/09/rails_on_ruby_jruby_a_performance_comparison.html">Running Rails on Ruby or JRuby - A Performance Comparison</a> <span>Sep  9 2012</span></li>
      
        <li><a href="/2012/09/01/deploying_java_apps_with_capistrano.html">Deploying Java applications with Capistrano</a> <span>Sep  1 2012</span></li>
      
        <li><a href="/2012/08/26/accessing_server_data_from_a_native_android_app.html">Accessing server data from a native Android app</a> <span>Aug 26 2012</span></li>
      
        <li><a href="/2012/08/18/why_javascript_is_important.html">Why JavaScript is important</a> <span>Aug 18 2012</span></li>
      
        <li><a href="/2012/06/08/non_tangibles_of_agile.html">The non-tangibles of Agile</a> <span>Jun  8 2012</span></li>
      
        <li><a href="/2012/05/28/moved_to_html.html">Blog moved to pure HTML5, CSS3</a> <span>May 28 2012</span></li>
      
        <li><a href="/2012/05/25/intro_to_backbone_jQuery.html">A gentle introduction to Backbone with jQuery</a> <span>May 25 2012</span></li>
      
        <li><a href="/2012/05/21/video_rubyconf_india.html">Video of my talk with @arunagw at RubyConf India 2012</a> <span>May 21 2012</span></li>
      
        <li><a href="/2012/05/08/setting_up_solr.html">Setting up Solr</a> <span>May  8 2012</span></li>
      
        <li><a href="/2012/03/27/old_jboss_video.html">Old JBoss Video</a> <span>Mar 27 2012</span></li>
      
        <li><a href="/2012/03/26/ruby_conf_india_with_arunagw.html">Slides of my talk with @arunagw in Ruby Conf India 2012</a> <span>Mar 26 2012</span></li>
      
        <li><a href="/2012/03/23/embracing_jruby_1.html">Embracing JRuby - Part 1</a> <span>Mar 23 2012</span></li>
      
        <li><a href="/2012/03/05/musings_on_india_and_technology.html">Musings on India and Technology</a> <span>Mar  5 2012</span></li>
      
        <li><a href="/2012/01/31/job_of_a_software_developer.html">The Job of a Software Developer</a> <span>Jan 31 2012</span></li>
      
        <li><a href="/2011/12/27/configuring-nginx-with-jboss-tomcat.html">Configuring nginx with JBoss / Tomcat</a> <span>Dec 27 2011</span></li>
      
        <li><a href="/2011/12/27/a-weekend-with-couchdb-solr-and-torquebox.html">A weekend with CouchDB, Solr and Torquebox</a> <span>Dec 27 2011</span></li>
      
        <li><a href="/2011/12/01/jquery-flavored-coffeescript.html">jQuery flavored CoffeeScript</a> <span>Dec  1 2011</span></li>
      
        <li><a href="/2011/07/26/and-then-there-was-closure.html">And then there was Closure</a> <span>Jul 26 2011</span></li>
      
        <li><a href="/2011/07/04/the-problem-is-choice.html">The problem is choice</a> <span>Jul  4 2011</span></li>
      
        <li><a href="/2011/06/29/using-spring-for-scheduling-tasks.html">Using Spring for Scheduling Tasks</a> <span>Jun 29 2011</span></li>
      
        <li><a href="/2011/06/25/working-with-oracle-on-linux-ubuntu-fedora.html">Installing Oracle on Linux (Ubuntu / Fedora)</a> <span>Jun 25 2011</span></li>
      
        <li><a href="/2011/06/25/excel-manipulation-and-testing-in-java.html">Excel manipulation and testing in Java</a> <span>Jun 25 2011</span></li>
      
        <li><a href="/2011/06/06/putting-couchdb-and-rails-on-the-cloud.html">Putting CouchDB and Rails on the Cloud</a> <span>Jun  6 2011</span></li>
      
        <li><a href="/2011/05/16/integrating-google-re-captcha-with-a-rails-app.html">Integrating Google Re-Captcha with a Rails app</a> <span>May 16 2011</span></li>
      
        <li><a href="/2011/05/03/the-real-purpose-of-a-sprint-goal.html">The real purpose of a Sprint Goal</a> <span>May  3 2011</span></li>
      
        <li><a href="/2011/05/02/thoughts-of-the-week-24-30-april.html">Thoughts of the week 24 - 30 April</a> <span>May  2 2011</span></li>
      
        <li><a href="/2011/05/02/views-from-across-the-table.html">Views from across the table</a> <span>May  2 2011</span></li>
      
        <li><a href="/2011/04/20/be-happy-to-fail.html">Be Happy to Fail</a> <span>Apr 20 2011</span></li>
      
        <li><a href="/2011/04/14/using-rvm-on-ubuntu-to-install-multiple-versions-of-ruby.html">Using RVM on Ubuntu to install (multiple versions of) Ruby</a> <span>Apr 14 2011</span></li>
      
        <li><a href="/2011/04/11/thoughts-of-the-week-4-10-april.html">Thoughts of the week (4 - 10 April)</a> <span>Apr 11 2011</span></li>
      
        <li><a href="/2011/04/08/mapreduce-in-english.html">MapReduce in English</a> <span>Apr  8 2011</span></li>
      
        <li><a href="/2011/04/01/hello-world.html">Integrating JRuby and Java to create a mini rules engine</a> <span>Apr  1 2011</span></li>
      
        <li><a href="/2011/04/01/java-and-ruby-integration-via-soap.html">Java and Ruby integration via SOAP</a> <span>Apr  1 2011</span></li>
      
        <li><a href="/2011/03/31/google-app-engine-maven-jsf2.html">Google App Engine + Maven + JSF2</a> <span>Mar 31 2011</span></li>
      
        <li><a href="/2011/03/31/hello-jquery.html">Hello jQuery!</a> <span>Mar 31 2011</span></li>
      
        <li><a href="/2011/03/31/integrating-spring-3-with-jpa-2.html">Integrating Spring 3 with JPA 2</a> <span>Mar 31 2011</span></li>
      
        <li><a href="/2011/03/31/accessing-jboss-managed-resources-using-mbeans.html">Accessing JBoss managed resources using MBeans</a> <span>Mar 31 2011</span></li>
      
        <li><a href="/2011/03/31/from-zero-to-a-crud-app-without-writing-a-single-line-of-code-using-jruby.html">From Zero to a CRUD App (without writing a single line of code) using JRuby</a> <span>Mar 31 2011</span></li>
      
        <li><a href="/2011/03/11/big-bad-projects.html">Big bad projects</a> <span>Mar 11 2011</span></li>
      
        <li><a href="/2011/03/01/working-with-git.html">Working with Git</a> <span>Mar  1 2011</span></li>
      
    </ol>
  </div>
  <div class="tags">
    <ol>
      
        <li><a href="/tags/git.html">Git (1)</a></li>
      
        <li><a href="/tags/agile.html">Agile (8)</a></li>
      
        <li><a href="/tags/jboss.html">JBoss (2)</a></li>
      
        <li><a href="/tags/jruby.html">JRuby (11)</a></li>
      
        <li><a href="/tags/cloud.html">Cloud (1)</a></li>
      
        <li><a href="/tags/java.html">Java (9)</a></li>
      
        <li><a href="/tags/maven.html">Maven (1)</a></li>
      
        <li><a href="/tags/jquery.html">jQuery (1)</a></li>
      
        <li><a href="/tags/jpa.html">JPA (1)</a></li>
      
        <li><a href="/tags/spring.html">Spring (2)</a></li>
      
        <li><a href="/tags/ruby.html">Ruby (8)</a></li>
      
        <li><a href="/tags/general.html">General (7)</a></li>
      
        <li><a href="/tags/rails.html">Rails (6)</a></li>
      
        <li><a href="/tags/couchdb.html">CouchDB (2)</a></li>
      
        <li><a href="/tags/linux.html">Linux (1)</a></li>
      
        <li><a href="/tags/programming.html">Programming (1)</a></li>
      
        <li><a href="/tags/javascript.html">JavaScript (11)</a></li>
      
        <li><a href="/tags/coffeescript.html">CoffeeScript (5)</a></li>
      
        <li><a href="/tags/nosql.html">NoSQL (1)</a></li>
      
        <li><a href="/tags/torquebox.html">Torquebox (4)</a></li>
      
        <li><a href="/tags/solr.html">Solr (2)</a></li>
      
        <li><a href="/tags/jboss.html">Jboss (1)</a></li>
      
        <li><a href="/tags/tomcat.html">Tomcat (1)</a></li>
      
        <li><a href="/tags/backbone.html">Backbone (6)</a></li>
      
        <li><a href="/tags/android.html">Android (1)</a></li>
      
        <li><a href="/tags/phonegap.html">Phonegap (1)</a></li>
      
        <li><a href="/tags/capistrano.html">Capistrano (1)</a></li>
      
        <li><a href="/tags/scala.html">Scala (2)</a></li>
      
        <li><a href="/tags/akka.html">Akka (1)</a></li>
      
        <li><a href="/tags/node-js.html">Node.js (1)</a></li>
      
        <li><a href="/tags/require-js.html">Require.js (2)</a></li>
      
        <li><a href="/tags/play.html">Play (1)</a></li>
      
        <li><a href="/tags/puppet.html">Puppet (1)</a></li>
      
        <li><a href="/tags/devops.html">DevOps (1)</a></li>
      
        <li><a href="/tags/scrum.html">Scrum (1)</a></li>
      
        <li><a href="/tags/angularjs.html">AngularJS (1)</a></li>
      
    </ol>
  </div>
  <hr/>
</div>

<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-10309067-3']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
  
  $(function() {
    $('.tags').hide();
    $("#show-tags").click(function() {
      $('.tags').toggle();
      $('.posts').toggle();
    });
    $("#show-posts").click(function() {
      $('.tags').toggle();
      $('.posts').toggle();
    });
  });
</script>
        </div>
      </div>
    </div>
  </body>
</html>