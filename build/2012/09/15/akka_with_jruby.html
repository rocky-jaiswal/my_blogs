<!DOCTYPE html>
<html>
  <head>
  <title>Rocky Jaiswal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="utf-8" />
  <meta http-equiv='X-UA-Compatible' content='IE=edge;chrome=1' />
  <link href="/stylesheets/app.css" media="screen" rel="stylesheet" type="text/css" />
  <link href="/stylesheets/bootstrap.css" media="screen" rel="stylesheet" type="text/css" />
  <link href="/stylesheets/bootstrap-responsive.css" media="screen" rel="stylesheet" type="text/css" />
  <link href="/stylesheets/github.css" media="screen" rel="stylesheet" type="text/css" />
  <script src="/javascripts/jquery.js" type="text/javascript"></script>
  <script src="/javascripts/bootstrap.js" type="text/javascript"></script>
  <script src="/javascripts/highlight.pack.js" type="text/javascript"></script>
</head>
  <body>
    <div class="banner">
  <div class="container">
    <h1>
      <a class="head" href="/"><img src="/images/rockyj_banner.png"/></a>
    </h1>
  </div>
</div>
    <div id="main" role="main" class="container">
      <div class="row">
        <div class="span9">
          <div id="main" role="main">
            <article>
              <h2>
                  <span class="color-orange">Akka with JRuby</span> 
                  <span>Sep 15 2012</span>
              </h2>
              <div class="post">
                <p>This week I completed my work project and had a spare day to do some experimentation. I dabble sometimes with Scala which I think offers a cool combination of FP, OO and concurrency management. <a href='http://akka.io'>Akka</a> is a middleware framework which works with Scala (and also Java) and provides an excellent abstraction to manage concurrency. Instead of dealing with threads, thread pools and low level synchronization we manage concurrency with something called as Actors.</p>

<p>From Akka&#8217;s site - &#8220;Actors are objects which encapsulate state and behavior, they communicate exclusively by exchanging messages which are placed into the recipientâ€™s mailbox. In a sense, actors are the most stringent form of object-oriented programming, but it serves better to view them as <strong>persons</strong>: while modeling a solution with actors, envision a group of people and assign sub-tasks to them, arrange their functions into an organizational structure and think about how to escalate failure (all with the benefit of not actually dealing with people, which means that we need not concern ourselves with their emotional state or moral issues). The result can then serve as a mental scaffolding for building the software implementation&#8221;.</p>

<p>I think this is a great abstraction, dealing with people rather than threads :). To understand more about Akka see <a href='http://www.slideshare.net/jboner/introducing-akka'>this presentation here</a>.</p>

<p>In my last blog, I talked about the advantages of using threads and the performace boost they give. I also warned about proper concurrency management when introducing threads to an application. If you need concurrency on a JRuby platform, Akka should be able to help you. After all anything that works on JVM should work on JRuby as well.</p>

<p>With this in mind I wrote a simple &#8220;Hello World&#8221; in JRuby and Akka. To make this work, download the Akka distribution, create a folder and copy the following jars from the downloaded Akka ditribution in it -</p>

<ul>
<li>akka-actor-xx.jar</li>

<li>config-xx.jar</li>

<li>scala-library.jar</li>
</ul>

<p>In the same folder create <strong>hello.rb</strong> like this -</p>

<pre><code>require &#39;java&#39;
require &#39;scala-library.jar&#39;
require &#39;config-0.3.1.jar&#39;
require &#39;akka-actor-2.0.3.jar&#39;

java_import &#39;java.io.Serializable&#39;
java_import &#39;akka.actor.UntypedActor&#39;
java_import &#39;akka.actor.ActorRef&#39;
java_import &#39;akka.actor.ActorSystem&#39;
java_import &#39;akka.actor.Props&#39;

class Greeting 
  include Serializable
  
  attr_reader :who

  def initialize(who)
    @who = who
  end
end
 
class GreetingActor &lt; UntypedActor
  class &lt;&lt; self
    alias_method :apply, :new
    alias_method :create, :new
  end

  def onReceive(message)
    puts &quot;Hello &quot; + message.who;
  end
end
 
system = ActorSystem.create(&quot;GreetingSystem&quot;);
props = Props.new(GreetingActor)
greeter = system.actorOf(props, &quot;greeter&quot;);
greeter.tell(Greeting.new(&quot;Rocky Jaiswal&quot;));

system.shutdown
system.await_termination</code></pre>

<p>This is dead simple code, we create an Actor (GreetingActor) by extending <strong>UnTypedActor</strong> class, provided it an onReceive method which will receive messages, we created an Actor system, setup an Actor and passed it a message and voila we have a &#8220;Hello World&#8221; Akka program.</p>

<p>Now if you want to do this in a more &#8220;Ruby&#8221; way, there is an excellent lightweight Ruby wrapper around Akka called <a href='https://github.com/iconara/mikka'>Mikka</a> which will make your life a lot easier. Since I wanted to learn the API more, I did it in the more &#8220;close to the metal&#8221; way (sorry bad joke).</p>

<p>Now for something more interesting and complicated. For this we will again look at the Akka site <a href='http://doc.akka.io/docs/akka/2.0.1/intro/getting-started-first-java.html'>here</a> and calculate &#8220;Pi&#8221; with JRuby and Akka. Sounds exciting doesn&#8217;t it.</p>

<p>The formula we will use is -</p>

<p><img alt='Pi calculation formula' src='/images/pi-formula.png' /></p>

<p>This is splittable so that we can create multiple chunks like (1, -1/3, 1/5) and (-1/7, 1/9, -1/11) and so on where each chunk has a number of elements (three in the example above). As these chunks are individually calculated we just sum up their results.</p>

<p>To work up the CPU and to get better results our number of chunks can be as high as ten thousand and each chunk can have ten thousand elements. You can go even higher if you want.</p>

<p>Now we need to setup an Actor system where each worker applies the function to the elements of its chunk and reports back with the results. Depending on your CPU we can create &#8220;n&#8221; number of workers. We can then assign the chunks to the workers one by one.</p>

<p>Finally when the Master has finished calculating the sum of the results reported by the workers it can notify another Actor that the value of Pi has been calculated.</p>

<p>So we have three Actors now, the Master or the supervisor Actor, the Worker Actor and finally a Listener Actor which is notified of the final result.</p>

<p>The Master Actor can recieve two types of messages, a &#8220;calculate&#8221; message which is an indication to commence the calculations and a &#8220;result&#8221; message which is a wrapper around the result calculated by a worker.</p>

<p>Now let us see the program <strong>pi.rb</strong> :</p>

<pre><code>require &#39;java&#39;
require &#39;scala-library.jar&#39;
require &#39;config-0.3.1.jar&#39;
require &#39;akka-actor-2.0.3.jar&#39;

java_import &#39;java.io.Serializable&#39;
java_import &#39;akka.actor.UntypedActor&#39;
java_import &#39;akka.actor.ActorRef&#39;
java_import &#39;akka.actor.ActorSystem&#39;
java_import &#39;akka.actor.UntypedActorFactory&#39;
java_import &#39;akka.routing.RoundRobinRouter&#39;
java_import &#39;akka.actor.Props&#39;
java_import &#39;java.lang.System&#39;
java_import &#39;akka.util.Duration&#39;
java_import &#39;java.util.concurrent.TimeUnit&#39;

#Wrapper for a calculate message
class Calculate
end

#Wrapper for a work unit
class Work 
  attr_reader :start, :no_of_elements

  def initialize(start, no_of_elements)
    @start = start
    @no_of_elements = no_of_elements
  end
end

#Wrapper for result
class Result 
  attr_reader :value

  def initialize(value)
    @value = value
  end
end

#Wrapper for final result
class PiApproximation
  attr_reader :pi, :duration

  def initialize(pi, duration)
    @pi = pi
    @duration = duration
  end
end

#The Worker
class Worker &lt; UntypedActor
  class &lt;&lt; self
    alias_method :apply, :new
    alias_method :create, :new
  end

  def calculate_for_pi(start, no_of_elements)
    acc = 0.0
    start_elem = start * no_of_elements
    end_elem = (start + 1) * no_of_elements - 1

    (start_elem..end_elem).each do |elem|
      acc = acc + (4.0 * (1 - (elem % 2) * 2) / (2 * elem + 1))
    end
    
    return acc
  end

  def onReceive(work)
    result = calculate_for_pi(work.start, work.no_of_elements)
    getSender().tell(Result.new(result), get_self)
  end
end

#Master
class Master &lt; UntypedActor
  attr_accessor :start, :no_of_workers, :no_of_chunks, :no_of_elements, :listener, :pi, :no_of_results
  
  class &lt;&lt; self
    alias_method :apply, :new
    alias_method :create, :new
  end

  def init_worker
    props = Props.new(Worker).withRouter(RoundRobinRouter.new(no_of_workers))
    @worker_router = self.get_context.actorOf(props, &quot;workerRouter&quot;)
  end

  def onReceive(message)
    if (message.is_a?(Calculate))
      (0...@no_of_chunks).each do |number|
        @worker_router.tell(Work.new(number, @no_of_elements), get_self)
      end
    else
      result = message
      @pi = @pi + result.value
      @no_of_results = @no_of_results + 1

      if (@no_of_results == @no_of_chunks)
        duration = Duration.create(System.currentTimeMillis - @start, TimeUnit::MILLISECONDS)
        @listener.tell(PiApproximation.new(@pi, duration), get_self)
        get_context.stop(get_self)
      end
    end
  end
end

class Listener &lt; UntypedActor
  class &lt;&lt; self
    alias_method :apply, :new
    alias_method :create, :new
  end

  def onReceive(message)
    puts &quot;Value of Pi - &quot; + message.pi.to_s
    puts &quot;Duration of calculation - &quot; + message.duration.to_s

    get_context.system.shutdown
    #get_context.system.await_termination
  end
end

class MasterFactory 
  include UntypedActorFactory

  def initialize(listener)
    @@listener = listener
  end

  def create
    self.class.create
  end

  def self.create
    master = Master.new
    master.no_of_workers = 8
    master.no_of_chunks = 10000
    master.no_of_elements = 10000
    master.listener = @@listener
    master.start = System.currentTimeMillis
    master.pi = 0
    master.no_of_results = 0
    master.init_worker
    return master
  end
end


system = ActorSystem.create(&quot;PiSystem&quot;)
listener = system.actorOf(Props.new(Listener), &quot;listener&quot;)

props_2 = Props.new(MasterFactory.new(listener))
master = system.actorOf(props_2, &quot;master&quot;)
master.tell(Calculate.new)</code></pre>

<p>If you read my explanation above this code is simple to understand, there is a minor hack or two to make Akka work on JRuby but most of this is self explanatory.</p>

<p>We can run this and see the output -</p>

<pre><code>$ jruby pi.rb 
Value of Pi - 3.1415926435897883
Duration of calculation - 5039 milliseconds</code></pre>

<p>Finally lets see the effect this has on my i7 CPU</p>

<p><img alt='akka cpu effect' src='/images/akka_cpu_effect.png' /></p>

<p>As you can see all 8 virtual cores on the i7 CPU have been used with utilization close to 100% at the time the program ran. I think my experiment is successful, sorry for the longish post, I hope you had as much fun reading it as I had making it. Code shown above is available <a href='https://github.com/rocky-jaiswal/akka-experiment'>here</a>.</p>
              </div>
              <hr/>
              <div id="disqus_thread"></div>
                <script type="text/javascript">
                  $(function(){
                    hljs.initHighlightingOnLoad();
                    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
                    var disqus_shortname = 'rockyj'; // required: replace example with your forum shortname

                    /* * * DON'T EDIT BELOW THIS LINE * * */
                    (function() {
                        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                    })();
                  });
                </script>
                <noscript>
                  Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
                </noscript>
                <a href="http://disqus.com" class="dsq-brlink">
                  blog comments powered by <span class="logo-disqus">Disqus</span>
                </a>
            </article>
          </div>
        </div>
        <div class="span3">
  <h2>
    <img src="/images/Rocky_Jaiswal.jpg" alt="Rocky Jaiswal" width="121" height="115" style="max-width: 100%;"/>
    <br/>
    <a href="/about">About</a>
  </h2>
  <hr/>
  <h2>
    <a href="http://github.com/rocky-jaiswal" target="_blank">Github</a>
  </h2>
  <hr/>
  <h2>Articles</h2>
  <ol>
    
      <li><a href="/2012/09/15/akka_with_jruby.html">Akka with JRuby</a> <span>Sep 15 2012</span></li>
    
      <li><a href="/2012/09/09/rails_on_ruby_jruby_a_performance_comparison.html">Running Rails on Ruby or JRuby - A Performance Comparison</a> <span>Sep  9 2012</span></li>
    
      <li><a href="/2012/09/01/deploying_java_apps_with_capistrano.html">Deploying Java applications with Capistrano</a> <span>Sep  1 2012</span></li>
    
      <li><a href="/2012/08/26/accessing_server_data_from_a_native_android_app.html">Accessing server data from a native Android app</a> <span>Aug 26 2012</span></li>
    
      <li><a href="/2012/08/18/why_javascript_is_important.html">Why JavaScript is important</a> <span>Aug 18 2012</span></li>
    
      <li><a href="/2012/06/08/non_tangibles_of_agile.html">The non-tangibles of Agile</a> <span>Jun  8 2012</span></li>
    
      <li><a href="/2012/05/28/moved_to_html.html">Blog moved to pure HTML5, CSS3</a> <span>May 28 2012</span></li>
    
      <li><a href="/2012/05/25/intro_to_backbone_jQuery.html">A gentle introduction to Backbone with jQuery</a> <span>May 25 2012</span></li>
    
      <li><a href="/2012/05/21/video_rubyconf_india.html">Video of my talk with @arunagw at RubyConf India 2012</a> <span>May 21 2012</span></li>
    
      <li><a href="/2012/05/08/setting_up_solr.html">Setting up Solr</a> <span>May  8 2012</span></li>
    
      <li><a href="/2012/03/27/old_jboss_video.html">Old JBoss Video</a> <span>Mar 27 2012</span></li>
    
      <li><a href="/2012/03/26/ruby_conf_india_with_arunagw.html">Slides of my talk with @arunagw in Ruby Conf India 2012</a> <span>Mar 26 2012</span></li>
    
      <li><a href="/2012/03/23/embracing_jruby_1.html">Embracing JRuby - Part 1</a> <span>Mar 23 2012</span></li>
    
      <li><a href="/2012/03/05/musings_on_india_and_technology.html">Musings on India and Technology</a> <span>Mar  5 2012</span></li>
    
      <li><a href="/2012/01/31/job_of_a_software_developer.html">The Job of a Software Developer</a> <span>Jan 31 2012</span></li>
    
      <li><a href="/2011/12/27/configuring-nginx-with-jboss-tomcat.html">Configuring nginx with JBoss / Tomcat</a> <span>Dec 27 2011</span></li>
    
      <li><a href="/2011/12/27/a-weekend-with-couchdb-solr-and-torquebox.html">A weekend with CouchDB, Solr and Torquebox</a> <span>Dec 27 2011</span></li>
    
      <li><a href="/2011/12/01/jquery-flavored-coffeescript.html">jQuery flavored CoffeeScript</a> <span>Dec  1 2011</span></li>
    
      <li><a href="/2011/07/26/and-then-there-was-closure.html">And then there was Closure</a> <span>Jul 26 2011</span></li>
    
      <li><a href="/2011/07/04/the-problem-is-choice.html">The problem is choice</a> <span>Jul  4 2011</span></li>
    
      <li><a href="/2011/06/29/using-spring-for-scheduling-tasks.html">Using Spring for Scheduling Tasks</a> <span>Jun 29 2011</span></li>
    
      <li><a href="/2011/06/25/working-with-oracle-on-linux-ubuntu-fedora.html">Installing Oracle on Linux (Ubuntu / Fedora)</a> <span>Jun 25 2011</span></li>
    
      <li><a href="/2011/06/25/excel-manipulation-and-testing-in-java.html">Excel manipulation and testing in Java</a> <span>Jun 25 2011</span></li>
    
      <li><a href="/2011/06/06/putting-couchdb-and-rails-on-the-cloud.html">Putting CouchDB and Rails on the Cloud</a> <span>Jun  6 2011</span></li>
    
      <li><a href="/2011/05/16/integrating-google-re-captcha-with-a-rails-app.html">Integrating Google Re-Captcha with a Rails app</a> <span>May 16 2011</span></li>
    
      <li><a href="/2011/05/03/the-real-purpose-of-a-sprint-goal.html">The real purpose of a Sprint Goal</a> <span>May  3 2011</span></li>
    
      <li><a href="/2011/05/02/views-from-across-the-table.html">Views from across the table</a> <span>May  2 2011</span></li>
    
      <li><a href="/2011/05/02/thoughts-of-the-week-24-30-april.html">Thoughts of the week 24 - 30 April</a> <span>May  2 2011</span></li>
    
      <li><a href="/2011/04/20/be-happy-to-fail.html">Be Happy to Fail</a> <span>Apr 20 2011</span></li>
    
      <li><a href="/2011/04/14/using-rvm-on-ubuntu-to-install-multiple-versions-of-ruby.html">Using RVM on Ubuntu to install (multiple versions of) Ruby</a> <span>Apr 14 2011</span></li>
    
      <li><a href="/2011/04/11/thoughts-of-the-week-4-10-april.html">Thoughts of the week (4 - 10 April)</a> <span>Apr 11 2011</span></li>
    
      <li><a href="/2011/04/08/mapreduce-in-english.html">MapReduce in English</a> <span>Apr  8 2011</span></li>
    
      <li><a href="/2011/04/01/java-and-ruby-integration-via-soap.html">Java and Ruby integration via SOAP</a> <span>Apr  1 2011</span></li>
    
      <li><a href="/2011/04/01/hello-world.html">Integrating JRuby and Java to create a mini rules engine</a> <span>Apr  1 2011</span></li>
    
      <li><a href="/2011/03/31/accessing-jboss-managed-resources-using-mbeans.html">Accessing JBoss managed resources using MBeans</a> <span>Mar 31 2011</span></li>
    
      <li><a href="/2011/03/31/from-zero-to-a-crud-app-without-writing-a-single-line-of-code-using-jruby.html">From Zero to a CRUD App (without writing a single line of code) using JRuby</a> <span>Mar 31 2011</span></li>
    
      <li><a href="/2011/03/31/google-app-engine-maven-jsf2.html">Google App Engine + Maven + JSF2</a> <span>Mar 31 2011</span></li>
    
      <li><a href="/2011/03/31/hello-jquery.html">Hello jQuery!</a> <span>Mar 31 2011</span></li>
    
      <li><a href="/2011/03/31/integrating-spring-3-with-jpa-2.html">Integrating Spring 3 with JPA 2</a> <span>Mar 31 2011</span></li>
    
      <li><a href="/2011/03/11/big-bad-projects.html">Big bad projects</a> <span>Mar 11 2011</span></li>
    
      <li><a href="/2011/03/01/working-with-git.html">Working with Git</a> <span>Mar  1 2011</span></li>
    
  </ol>
  <hr/>
  <h2>Tags</h2>
  <ol>
    
      <li><a href="tags/jboss.html">JBoss (2)</a></li>
    
      <li><a href="tags/agile.html">Agile (7)</a></li>
    
      <li><a href="tags/general.html">General (6)</a></li>
    
      <li><a href="tags/java.html">Java (9)</a></li>
    
      <li><a href="tags/jruby.html">JRuby (9)</a></li>
    
      <li><a href="tags/ruby.html">Ruby (7)</a></li>
    
      <li><a href="tags/capistrano.html">Capistrano (1)</a></li>
    
      <li><a href="tags/git.html">Git (1)</a></li>
    
      <li><a href="tags/javascript.html">JavaScript (4)</a></li>
    
      <li><a href="tags/solr.html">Solr (2)</a></li>
    
      <li><a href="tags/jpa.html">JPA (1)</a></li>
    
      <li><a href="tags/spring.html">Spring (2)</a></li>
    
      <li><a href="tags/coffeescript.html">CoffeeScript (1)</a></li>
    
      <li><a href="tags/rails.html">Rails (3)</a></li>
    
      <li><a href="tags/torquebox.html">Torquebox (3)</a></li>
    
      <li><a href="tags/couchdb.html">CouchDB (2)</a></li>
    
      <li><a href="tags/nosql.html">NoSQL (1)</a></li>
    
      <li><a href="tags/jquery.html">jQuery (1)</a></li>
    
      <li><a href="tags/backbone.html">Backbone (2)</a></li>
    
      <li><a href="tags/linux.html">Linux (1)</a></li>
    
      <li><a href="tags/programming.html">Programming (1)</a></li>
    
      <li><a href="tags/android.html">Android (1)</a></li>
    
      <li><a href="tags/phonegap.html">Phonegap (1)</a></li>
    
      <li><a href="tags/scala.html">Scala (1)</a></li>
    
      <li><a href="tags/akka.html">Akka (1)</a></li>
    
      <li><a href="tags/jboss.html">Jboss (1)</a></li>
    
      <li><a href="tags/tomcat.html">Tomcat (1)</a></li>
    
      <li><a href="tags/cloud.html">Cloud (1)</a></li>
    
      <li><a href="tags/maven.html">Maven (1)</a></li>
    
  </ol>
  <hr/>
</div>
      </div>
    </div>
  </body>
</html>