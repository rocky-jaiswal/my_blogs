<!DOCTYPE html>
<html>
  <head>
    <title>Rocky Jaiswal</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="utf-8" />
    <meta http-equiv='X-UA-Compatible' content='IE=edge;chrome=1' />
    <link href="/stylesheets/app.css" media="screen" rel="stylesheet" type="text/css" />
    <link href="/stylesheets/bootstrap.css" media="screen" rel="stylesheet" type="text/css" />
    <link href="/stylesheets/bootstrap-responsive.css" media="screen" rel="stylesheet" type="text/css" />
    <script src="/javascripts/bootstrap.js" type="text/javascript"></script>
    <link href='http://fonts.googleapis.com/css?family=Ultra' rel='stylesheet' type='text/css'>
  </head>

  <body>
    <div class="banner">
      <div class="container">
        <h1>
          <a class="head" href="/">Still Learning ...</a>
        </h1>
        <p class="sub-title">Musings of an agile developer</p>
      </div>
    </div>

    <div id="main" role="main" class="container">
      <div class="row">
        <div class="span12">
          <div id="main" role="main">
            <article>
              <h2>
                  <span class="color-orange">Integrating Spring 3 with JPA 2</span> 
                  <span>Mar 31 2011</span>
              </h2>
              
              <div class="post">
                <p>I have been working on Grails recently and am amazed with the productivity gains it gives. Grails is great for giving you a kick-start, it uses convention over configuration and gives you things such as ORM, transaction management, dependency injection among others, without you writing a single line of configuration.</p>

<p>I decided to mimic the Grails behavior in a Spring + Hibernate application. To stay on the cutting edge I decided to use Hibernate 3.5 and Spring 3, to top it up I decided to use Hibernate as an implementation of JPA 2. Recently released, Hibernate 3.5 combines the Hibernate Annotations and the Hibernate Entity-Manager projects into Hibernate-Core, so basically its just one jar which provides the full implementation of JPA 2. For advantages of using JPA 2 see the excellent presentation here - <a href='http://jazoon.com/portals/0/Content/ArchivWebsite/jazoon.com/jazoon09/download/presentations/8461.pdf'>http://jazoon.com/portals/0/Content/ArchivWebsite/jazoon.com/jazoon09/download/presentations/8461.pdf</a></p>

<p><strong>Integrating Hibernate with JPA 2</strong></p>

<p>As usual, I started with a vanilla maven web project and started adding dependencies, the first being Hibernate -</p>

<pre><code>&lt;dependency&gt;
&lt;groupId&gt;org.hibernate&lt;/groupId&gt;
&lt;artifactId&gt;hibernate-core&lt;/artifactId&gt;
&lt;version&gt;3.5.4-Final&lt;/version&gt;
&lt;/dependency&gt;</code></pre>

<p>This dependency is found in the repository - <a href='https://repository.jboss.org/nexus/content/groups/public/'>https://repository.jboss.org/nexus/content/groups/public/</a> as mentioned on the Hibernate site. After a lot of pain I found that this jar did not match the jar you from <a href='http://sourceforge.net/projects/hibernate/files/hibernate3'>http://sourceforge.net/projects/hibernate/files/hibernate3</a>. So, I had to manually install the jar in my local repository (remember, I found this out after setting up JPA, Spring etc. which I will cover next). Similarly, in the JBoss repository I could not find the JPA 2 specfication jar (again available if you download the Hibernate distribution from sourceforge).I had to install that manually as well. After all this jiggery-pokery and some more, I somehow got Hibernate and JPA working.</p>

<p>JPA needs a persistence.xml file in META-INF folder in the classpath. I added META-INF folder in source/main/resources with persistence.xml reading as -</p>

<pre><code>&lt;persistence xmlns=&quot;http://java.sun.com/xml/ns/persistence&quot;
    xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
    xsi:schemaLocation=&quot;http://java.sun.com/xml/ns/persistence http://java.sun.com/xml/ns/persistence/persistence_2_0.xsd&quot;
    version=&quot;2.0&quot;&gt;
	&lt;persistence-unit name=&quot;postage&quot; transaction-type=&quot;RESOURCE_LOCAL&quot;&gt;
		&lt;provider&gt;org.hibernate.ejb.HibernatePersistence&lt;/provider&gt;
	&lt;/persistence-unit&gt;
&lt;/persistence&gt;</code></pre>

<p>So, here I basically tell JPA that Hibernate is providing its implementation. Plus I give my persistence-unit a name &#8220;postage&#8221; (the name of my application).</p>

<p><strong>Integrating Spring with JPA</strong></p>

<p>Now, I need to get Spring working with JPA and it is not exactly a cakewalk. With a lot of people pointing in different directions and the Spring documentation itself not very helpful in this particular aspect.</p>

<p>The Spring JPA support itself offers three ways of setting up the JPA EntityManagerFactory, so that it can be used by the application to obtain an entity manager. I chose the &#8220;LocalContainerEntityManagerFactoryBean&#8221; because it gives full control over EntityManagerFactory configuration and is appropriate for fine-grained customization, if required. Below is my config -</p>

<pre><code>&lt;bean id=&quot;entityManagerFactory&quot; class=&quot;org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean&quot;
	p:dataSource-ref=&quot;dataSource&quot;&gt;
	&lt;property name=&quot;jpaProperties&quot;&gt;
		&lt;props&gt;
			&lt;prop key=&quot;hibernate.dialect&quot;&gt;${hibernate.dialect}&lt;/prop&gt;
			&lt;prop key=&quot;hibernate.hbm2ddl.auto&quot;&gt;${hibernate.hbm2ddl.auto}&lt;/prop&gt;
			&lt;prop key=&quot;hibernate.show_sql&quot;&gt;${hibernate.show_sql}&lt;/prop&gt;
		&lt;/props&gt;
	&lt;/property&gt;      
&lt;/bean&gt;</code></pre>

<p>As evident, you need a &#8220;dataSource&#8221; bean defined, which looks like -</p>

<pre><code>&lt;bean id=&quot;dataSource&quot; class=&quot;org.springframework.jdbc.datasource.DriverManagerDataSource&quot;
	p:driverClassName=&quot;${dataSource.driverClassName}&quot;
	p:url=&quot;${dataSource.url}&quot;
	p:username=&quot;${dataSource.username}&quot;
	p:password=&quot;${dataSource.password}&quot;
/&gt;</code></pre>

<p>To get the &#8220;${}&#8221; thingy working, i.e. a properties file lookup, add -</p>

<pre><code>&lt;context:property-placeholder location=&quot;classpath:datasource.properties&quot;/&gt;</code></pre>

<p>datasource.properties can look like -</p>

<pre><code>dataSource.driverClassName=org.hsqldb.jdbcDriver
dataSource.url=jdbc:hsqldb:mem:postage
dataSource.username=sa
dataSource.password=
#Hibernate Properties
hibernate.hbm2ddl.auto=create-drop
hibernate.dialect=org.hibernate.dialect.HSQLDialect
hibernate.show_sql=true</code></pre>

<p>To get transactions working, add -</p>

<pre><code>&lt;tx:annotation-driven/&gt;</code></pre>

<p>And define a transaction manager -</p>

<pre><code>&lt;bean id=&quot;transactionManager&quot; class=&quot;org.springframework.orm.jpa.JpaTransactionManager&quot;
		p:entityManagerFactory-ref=&quot;entityManagerFactory&quot;
/&gt;</code></pre>

<p>Now, assuming that you have an Entity &#8220;Post&#8221;, lets create the DAO -</p>

<pre><code>@Repository
@Transactional
public class PostageDAOImpl implements PostageDAO {

	@PersistenceContext
	private EntityManager em;

	public void savePost(Post post){
		em.persist(post);
		em.flush();
	}

}</code></pre>

<p>The @Transactional annotation makes the DAO transactional (remember we added <a href='tx:annotation-driven/'>tx:annotation-driven/</a>). Let&#8217;s look at the other Annotations - @Repository annotation is a &#8220;stereotype&#8221; annotation added in Spring 2.5 which enables Spring to identify Beans for AOP pointcuts. In our case @Repository annotation also enables Spring to automatically convert JPA exceptions to Spring exception hierarchy. Finally, the EntityManager is automatically injected by Spring as it is annotated by @PersistenceContext. Also add -</p>

<pre><code>  &lt;context:component-scan base-package=&quot;net.rocky.postage&quot;/&gt;</code></pre>

<p>This tag enables dependency injection with annotations and also auto-detects stereotype classes in the specified package and registers the corresponding beans.</p>

<p>That&#8217;s it! We have integrated Spring with JPA 2 and Hibernate. Let&#8217;s write a test case to verify our setup -</p>

<pre><code>@RunWith(SpringJUnit4ClassRunner.class)
@ContextConfiguration(&quot;/applicationContext.xml&quot;)
public class PostageDAOImplTest {

	@Resource
	private PostageDAO postageDAOImpl;

	@Test
	public void testPostStorage() throws Exception {
		Post post = new Post();
		post.setComments(&quot;A simple comment&quot;);
		post.setDescription(&quot;A simple description&quot;);
		postageDAOImpl.savePost(post);
	}

...</code></pre>

<p><strong>Parting thoughts</strong></p>

<p>This whole exercise took me a long time due to lack of comprehensive documentation, version mismatches and multiple approaches suggested by documents/bloggers. The advantage of the approach I have suggested above is that it allows you to switch to different databases for test/production as the datasource and dialect is specified in a .properties file.</p>

<p>The big idea behind this exercise was to setup a DAO and domain layer akin to Grails which can be easily scaled up. We can further add a service layer to access the data and then use it over a UI. For my next blog I will build on this and create a web application that uses GWT as the front-end.</p>
              </div>

              <div id="disqus_thread"></div>
                <script type="text/javascript">
                    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
                    var disqus_shortname = 'rockyj'; // required: replace example with your forum shortname

                    /* * * DON'T EDIT BELOW THIS LINE * * */
                    (function() {
                        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                    })();
                </script>
                <noscript>
                  Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
                </noscript>
                <a href="http://disqus.com" class="dsq-brlink">
                  blog comments powered by <span class="logo-disqus">Disqus</span>
                </a>
            </article>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>