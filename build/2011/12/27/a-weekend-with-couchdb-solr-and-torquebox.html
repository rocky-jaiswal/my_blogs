<!DOCTYPE html>
<html>
  <head>
    <title>Rocky Jaiswal</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="utf-8" />
    <meta http-equiv='X-UA-Compatible' content='IE=edge;chrome=1' />
    <link href="/stylesheets/app.css" media="screen" rel="stylesheet" type="text/css" />
    <link href="/stylesheets/bootstrap.css" media="screen" rel="stylesheet" type="text/css" />
    <link href="/stylesheets/bootstrap-responsive.css" media="screen" rel="stylesheet" type="text/css" />
    <script src="/javascripts/bootstrap.js" type="text/javascript"></script>
    <link href='http://fonts.googleapis.com/css?family=Ultra' rel='stylesheet' type='text/css'>
  </head>

  <body>
    <div class="banner">
      <div class="container">
        <h1>
          <a class="head" href="/">Still Learning ...</a>
        </h1>
        <p class="sub-title">Musings of an agile developer</p>
      </div>
    </div>

    <div id="main" role="main" class="container">
      <div class="row">
        <div class="span12">
          <div id="main" role="main">
            <article>
              <h2>
                  <span class="color-orange">A weekend with CouchDB, Solr and Torquebox</span> 
                  <span>Dec 27 2011</span>
              </h2>
              
              <div class="post">
                <p>Ok, I am lying it was actually a long weekend and I had something working beforehand (but that was before I knew Ruby or really understood how to write decent Ruby code, I am just a little bit better now). I am really excited about JRuby, it has a bright future ahead once JDK 7 matures and InvokedDynamics stabilizes. So I decided to write a new application in JRuby and serve it with <a href='http://torquebox.org/'>Torquebox</a>. For data persistence I chose CouchDB.</p>

<p>With RVM and JDK in place I installed JRuby, installing Torquebox is as simple as doing -</p>

<pre><code>    rvm jruby
    jruby -J-Xmx1024m -S gem install torquebox-server --pre</code></pre>

<p>Create a new Rails application as normal. Go to the root folder of that application and do -</p>

<pre><code>    torquebox deploy
    and
    torquebox run</code></pre>

<p>You application will now be served from port 8080 and works like a normal Rails application. Since I did not use any relational DB I disabled activerecord in application.rb.</p>

<p>The application I made helps users in searching for verses in the Bible. So I downloaded and cleansed a pure text version of King James translation and wrote a script to store every verse as a CouchDB document.</p>

<p>Since I also wanted search, I decided to use Solr. The catch with Solr is that there is hardly any documentation available. I decided to go with the Solr &#8220;example&#8221; setup. So you do a -</p>

<pre><code>    java -jar start.jar</code></pre>

<p>In the Solr example directory. The Solr config for this is located in the &#8220;solr&#8221; sub-directory.</p>

<p>Next, I wanted to index each verse (a document in CouchDB) with Solr. In my gemfile, I included the &#8220;RSolr&#8221; and &#8220;Couchrest&#8221; gem, they provide a nice layer of abstraction over CouchDB and Solr. Next I wrote a Rake task -</p>

<pre><code>    namespace :solr do

    desc &quot;Send docs from CouchDB to Solr for indexing&quot;
    task :setup =&gt; :environment do
    db = CouchRest.database(&quot;http://localhost:5984/the_bible&quot;)
    data = db.view(&quot;verse/lookup&quot;)[&#39;rows&#39;]

    solr = RSolr.connect :url =&gt; &#39;http://localhost:8983/solr&#39;

    data.each do |record|
      id = record[&#39;id&#39;]
      value = record[&#39;value&#39;]
      solr.add(:id =&gt; id, :verse =&gt; value)
    end
    solr.update :data =&gt; &#39;&lt;commit/&gt;&#39;
    end

    desc &quot;Search for verse - just for testing setup&quot;
    task :search =&gt; :environment do
    solr = RSolr.connect :url =&gt; &#39;http://localhost:8983/solr&#39;
    response = solr.get &#39;select&#39;, :params =&gt; {
        :q=&gt;&#39;verse:Jesus&#39;,
        :start=&gt;0,
        :rows=&gt;10
    }
    puts response.inspect
    end

    end</code></pre>

<p>Basically, the setup task queries a CouchDB view (which returns all the verses) and using RSolr I submit these documents to Solr, note that documents in both CouchDB and Solr use the same id, this helps me in retrieval later.</p>

<p>Basically, I got this idea as both CouchDB and Solr speak JSON. So I can store documents in CouchDB and retrieve them as JSON and store the same JSON in Solr for searching.</p>

<p>In Solr, I am submitting my documents with the field name &#8220;verse&#8221;, this requires a change in Solr schema. I realized this after a lot of head-banging. Just open schema.xml and add a new field &#8220;verse&#8221; with the type &#8220;free_text&#8221;. There are already some examples present, you can&#8217;t go wrong.</p>

<p>That&#8217;s it for simple read-only data we are all done. If your data is updatable, on each update of CouchDB write a background job that updates Solr as well.</p>

<p>My site is available at - <a href='http://biblefind.in'>here</a> and the whole source code on <a href='https://github.com/rocky-jaiswal/biblefind'>github</a>.</p>
              </div>

              <hr/>

              <div id="disqus_thread"></div>
                <script type="text/javascript">
                    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
                    var disqus_shortname = 'rockyj'; // required: replace example with your forum shortname

                    /* * * DON'T EDIT BELOW THIS LINE * * */
                    (function() {
                        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                    })();
                </script>
                <noscript>
                  Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
                </noscript>
                <a href="http://disqus.com" class="dsq-brlink">
                  blog comments powered by <span class="logo-disqus">Disqus</span>
                </a>
            </article>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>