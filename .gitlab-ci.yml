image: ruby:2.3

stages:
  - build
  - docker
  - deploy

build:
  stage: build
  artifacts:
    paths:
      - ./build
  script:
    - bundle install --deployment
    - bundle exec middleman build

docker:
  stage: docker
  image: docker:git
  services:
    - docker:dind
  dependencies:
    - build
  script:
    - docker login registry.gitlab.com -u rocky-jaiswal -p $GITLAB_TOKEN
    - docker build -t registry.gitlab.com/rocky-jaiswal/my_blogs:$CI_COMMIT_SHA .
    - docker push registry.gitlab.com/rocky-jaiswal/my_blogs:$CI_COMMIT_SHA

deploy:
  stage: deploy
  script:
    - 'echo "{\"service-name\": \"my-blogs\"," > body.json'
    - 'echo "\"image-name\": \"BLOG_IMAGE_ID\"," >> body.json'
    - 'echo "\"image-id\": \"$CI_COMMIT_SHA\"," >> body.json'
    - 'echo "\"image-path\": \"registry.gitlab.com/rocky-jaiswal/my_blogs:$CI_COMMIT_SHA\"}" >> body.json'
    - 'cat body.json'
    - 'curl -X PUT https://rockyj.in/__deployer/service -H "Authorization: Basic $DEPLOYER_AUTH" -H "Content-Type: application/json" --data @body.json'
